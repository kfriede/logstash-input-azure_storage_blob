name: Dev Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build & Publish Dev Gem
    runs-on: ubuntu-latest
    services:
      azurite:
        image: mcr.microsoft.com/azure-storage/azurite
        ports:
          - 10000:10000
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5.0.1

      - name: Set up Java 11
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: '11'

      - name: Install Logstash
        run: |
          wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elastic-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/elastic-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list
          sudo apt-get update && sudo apt-get install -y logstash

      - name: Download Logstash build support files
        run: |
          LS_VERSION=$(dpkg-query -W -f='${Version}' logstash | sed 's/^1://; s/-[0-9]*$//')
          echo "Logstash version: ${LS_VERSION}"
          sudo curl -sfL "https://raw.githubusercontent.com/elastic/logstash/v${LS_VERSION}/rubyUtils.gradle" -o /usr/share/logstash/rubyUtils.gradle
          sudo curl -sfL "https://raw.githubusercontent.com/elastic/logstash/v${LS_VERSION}/versions.yml" -o /usr/share/logstash/versions.yml

      - name: Run unit tests
        run: ./gradlew test

      - name: Run integration tests
        run: ./gradlew integrationTest

      - name: Build gem
        run: ./gradlew gem

      - name: Rename gem to stable filename
        run: cp logstash-input-azure_storage_blob-*-java.gem logstash-input-azure_storage_blob-dev-java.gem

      - name: Publish to dev release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: dev
          name: Dev Build
          body: |
            Rolling dev build from `main`. Updated on every push.

            **Install in Logstash:**
            ```bash
            curl -Lo /tmp/plugin.gem https://github.com/kfriede/logstash-input-azure_storage_blob/releases/download/dev/logstash-input-azure_storage_blob-dev-java.gem
            logstash-plugin install --no-verify /tmp/plugin.gem
            ```

            **Last built from:** ${{ github.sha }}
          prerelease: true
          files: logstash-input-azure_storage_blob-dev-java.gem
